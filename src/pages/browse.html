<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Menu - Meraki Sipside</title>
    <link rel="stylesheet" href="../styles/style.css" />
    <link rel="stylesheet" href="../styles/browse.css" />
    <script src="../scripts/app.js" defer></script>
    <script src="../scripts/cart.js" type="module" defer></script>
    <script type="module">
        import { isBestSeller } from '../scripts/bestseller-config.js';
        
        // render items and wire add-to-checkout + category filtering + size handling
        document.addEventListener('DOMContentLoaded', () => {
            const items = [
                { id: 'm1', name: 'Bubble Tea', prices: { Grande: 39, Venti: 49 }, description: 'Classic milktea with chewy tapioca pearls', category: 'Milktea' },
                { id: 'm2', name: 'Cookies & Cream', prices: { Grande: 39, Venti: 49 }, description: 'Creamy milktea with crushed cookies', category: 'Milktea' },
                { id: 'm3', name: 'Choco Hokkaido', prices: { Grande: 39, Venti: 49 }, description: 'Rich chocolate Hokkaido cream flavor', category: 'Milktea' },
                { id: 'm4', name: 'Matcha', prices: { Grande: 39, Venti: 49 }, description: 'Premium Japanese green tea milktea', category: 'Milktea' },
                { id: 'm5', name: 'Winter Melon', prices: { Grande: 39, Venti: 49 }, description: 'Sweet and refreshing winter melon', category: 'Milktea' },
                { id: 'm6', name: 'Okinawa', prices: { Grande: 39, Venti: 49 }, description: 'Brown sugar specialty from Okinawa', category: 'Milktea' },
                { id: 'm7', name: 'Red Velvet', prices: { Grande: 39, Venti: 49 }, description: 'Velvety smooth red velvet flavor', category: 'Milktea' },
                { id: 'm8', name: 'Chocolate', prices: { Grande: 39, Venti: 49 }, description: 'Classic rich chocolate milktea', category: 'Milktea' },
               
                { id: 'ic1', name: 'Spanish Latte', price: 49, description: 'Creamy and sweet coffee with condensed milk', category: 'Iced Coffee' },
                { id: 'ic2', name: 'French Vanilla', price: 49, description: 'Smooth vanilla-infused coffee', category: 'Iced Coffee' },
                { id: 'ic3', name: 'Salted Caramel', price: 49, description: 'Perfect balance of sweet and salty', category: 'Iced Coffee' },
                { id: 'ic4', name: 'Dark Mocha', price: 49, description: 'Rich chocolate blended with espresso', category: 'Iced Coffee' },
                { id: 'ic5', name: 'Matcha', price: 49, description: 'Green tea latte with a coffee twist', category: 'Iced Coffee' },
                { id: 'ic6', name: 'Hazelnut', price: 49, description: 'Nutty hazelnut coffee delight', category: 'Iced Coffee' },
               
                { id: 'ch1', name: 'Oreo Matcha', prices: { Grande: 59, Venti: 69 }, description: 'Matcha cheesecake with oreo crumbles', category: 'Cheesecake' },
                { id: 'ch2', name: 'Red Velvet', prices: { Grande: 59, Venti: 69 }, description: 'Smooth red velvet cheesecake', category: 'Cheesecake' },
                { id: 'ch3', name: 'Oreolicious', prices: { Grande: 59, Venti: 69 }, description: 'Loaded with crushed oreo cookies', category: 'Cheesecake' },
                { id: 'ch4', name: 'Creamy Cheesecake', prices: { Grande: 59, Venti: 69 }, description: 'Classic New York style cheesecake', category: 'Cheesecake' },
                { id: 'ch5', name: 'Choco Delight', prices: { Grande: 59, Venti: 69 }, description: 'Decadent chocolate cheesecake', category: 'Cheesecake' },
                
                { id: 'ft1', name: 'Lychee', price: 49, description: 'Sweet and fragrant lychee tea', category: 'Fruit Tea' },
                { id: 'ft2', name: 'Orange', price: 49, description: 'Refreshing citrus orange tea', category: 'Fruit Tea' },
                { id: 'ft3', name: 'Blueberry', price: 49, description: 'Fresh blueberry fruit tea', category: 'Fruit Tea' },
                { id: 'ft4', name: 'Apple Green', price: 49, description: 'Crisp green apple tea', category: 'Fruit Tea' },
                { id: 'ft5', name: 'Four Season', price: 49, description: 'Classic oolong fruit tea blend', category: 'Fruit Tea' },
                { id: 'ft6', name: 'Strawberry', price: 49, description: 'Sweet strawberry fruit tea', category: 'Fruit Tea' },
                { id: 'ft7', name: 'Passion Fruit', price: 49, description: 'Tropical passion fruit tea', category: 'Fruit Tea' },
               
                { id: 's1', name: 'Green Sparkle', prices: { Grande: 49, Venti: 59 }, description: 'Refreshing lime soda sparkler', category: 'Soda' },
                { id: 's2', name: 'Blueberry Cloud', prices: { Grande: 49, Venti: 59 }, description: 'Blueberry soda with creamy clouds', category: 'Soda' },
                { id: 's3', name: 'Lychee Soda Pop', prices: { Grande: 49, Venti: 59 }, description: 'Sweet lychee sparkling soda', category: 'Soda' },
                { id: 's4', name: 'Strawberry Burst', prices: { Grande: 49, Venti: 59 }, description: 'Berry explosion in every sip', category: 'Soda' },
                { id: 's5', name: 'Blue Lagoon', prices: { Grande: 49, Venti: 59 }, description: 'Tropical blue curacao soda', category: 'Soda' },
                { id: 's6', name: 'Sparkling Apple Dew', prices: { Grande: 49, Venti: 59 }, description: 'Crisp sparkling apple soda', category: 'Soda' },
                
                { id: 'frp1', name: 'Loaded Java Chips', price: 79, description: 'Coffee frappe with oreo and chocolate chips', category: 'Frappe' },
                { id: 'frp2', name: 'Mango', price: 79, description: 'Tropical mango blended frappe', category: 'Frappe' },
                { id: 'frp3', name: 'Creamy Avocado', price: 79, description: 'Smooth and creamy avocado frappe', category: 'Frappe' },
                { id: 'frp4', name: 'Ube', price: 79, description: 'Filipino purple yam frappe', category: 'Frappe' },
                { id: 'frp5', name: 'Strawberry', price: 79, description: 'Fresh strawberry blended delight', category: 'Frappe' },
                { id: 'frp6', name: 'Bubble Gum', price: 79, description: 'Sweet bubblegum flavored frappe', category: 'Frappe' },
               
                { id: 'sn1', name: 'Regular Corndog', price: 40, description: 'Classic deep-fried corndog', category: 'Snacks' },
                { id: 'sn2', name: 'Cheezy Corndog', price: 45, description: 'Corndog with melted cheese filling', category: 'Snacks' },
                { id: 'sn3', name: 'Classic Burger', price: 25, description: 'Simple and delicious burger', category: 'Snacks' },
                { id: 'sn4', name: 'Cheese Burger', price: 35, description: 'Burger with melted cheese', category: 'Snacks' },
                { id: 'sn5', name: 'Egg Burger', price: 45, description: 'Burger with fried egg', category: 'Snacks' },
                { id: 'sn6', name: 'Egg Burger With Cheese', price: 50, description: 'Burger with egg and cheese', category: 'Snacks' },
                { id: 'sn7', name: 'Egg Sandwich', price: 30, description: 'Simple egg sandwich on soft bread', category: 'Snacks' },
                { id: 'sn8', name: 'Ham & Egg Sandwich', price: 55, description: 'Ham and egg breakfast sandwich', category: 'Snacks' },
                { id: 'sn9', name: 'Classic Hotdog', price: 30, description: 'Simple grilled hotdog', category: 'Snacks' },
                { id: 'sn10', name: 'Cheezy Hotdog', price: 45, description: 'Hotdog with melted cheese', category: 'Snacks' },
                { id: 'sn11', name: 'Overload Hotdog', price: 70, description: 'Fully loaded with all toppings', category: 'Snacks' },
                
                { id: 'fries1', name: 'Cheese Fries', prices: { R: 45, M: 65, L: 95 }, description: 'Crispy fries with melted cheese', category: 'Fries' },
                { id: 'fries2', name: 'Sour Cream Fries', prices: { R: 45, M: 65, L: 95 }, description: 'Fries with tangy sour cream', category: 'Fries' },
                { id: 'fries3', name: 'BBQ Fries', prices: { R: 45, M: 65, L: 95 }, description: 'BBQ seasoned crispy fries', category: 'Fries' },
                { id: 'fries4', name: 'Overload Cheezy', price: 75, description: 'Extra cheesy fully loaded fries', category: 'Fries' }
            ];

            const sizeDisplayMap = {
                Grande: 'Grande (16 oz)',
                Venti: 'Venti (20 oz)'
            };

            const placeholderImg = '../assets/menu/placeholder.jfif';
            const assetBasePath = '../assets/menu/';

            const getImagePath = (id) => `${assetBasePath}${id}.jpg`;

            const setupImageFallback = (imgEl) => {
                if (!imgEl) return;
                imgEl.onerror = () => {
                    imgEl.src = placeholderImg;
                    imgEl.onerror = null;
                };
            };
            const itemModal = document.getElementById('item-modal');
            const modalImg = document.querySelector('#item-modal .modal-img');
            const modalTitle = document.getElementById('item-modal-title');
            const modalDesc = document.getElementById('item-modal-desc');
            const modalPrice = document.getElementById('item-modal-price');
            const modalSize = document.getElementById('item-modal-size');
            const modalAddBtn = document.getElementById('modal-add');
            const modalCancelBtn = document.getElementById('modal-cancel');
            const modalCloseBtn = document.getElementById('modal-close');

            let modalItem = null;
            let lastTrigger = null;

            function showToast(message) {
                const toastEl = document.getElementById('ms-toast');
                if (toastEl) {
                    toastEl.textContent = message;
                    toastEl.classList.add('visible');
                    setTimeout(() => toastEl.classList.remove('visible'), 1600);
                } else {
                    const temp = document.createElement('div');
                    temp.className = 'ms-toast visible';
                    temp.textContent = message;
                    document.body.appendChild(temp);
                    setTimeout(() => temp.remove(), 1600);
                }
            }

            function addItemToCart(item, size) {
                const imagePath = getImagePath(item.id);
                const actualSize = item.prices ? (size || Object.keys(item.prices)[0]) : null;
                const price = item.prices ? item.prices[actualSize] : item.price;
                const displaySize = actualSize ? (sizeDisplayMap[actualSize] || actualSize) : null;
                const cartItem = {
                    id: item.prices ? `${item.id}_${actualSize}` : item.id,
                    baseId: item.id,
                    name: item.name,
                    description: item.description,
                    size: displaySize,
                    price,
                    image: imagePath
                };
                MerakiCart.addToCart(cartItem);
                MerakiCart.updateCartDisplay();
                const sizeSuffix = displaySize ? ` (${displaySize})` : '';
                showToast(`${item.name}${sizeSuffix} added to checkout.`);
            }

            function getModalSelectedSize() {
                const selected = modalSize.querySelector('input[name="modal-size"]:checked');
                return selected ? selected.value : null;
            }

            function updateModalPrice() {
                if (!modalItem) return;
                if (modalItem.prices) {
                    const size = getModalSelectedSize() || Object.keys(modalItem.prices)[0];
                    const price = modalItem.prices[size];
                    modalPrice.textContent = `Price: ₱${Number(price).toFixed(0)}`;
                } else {
                    modalPrice.textContent = `Price: ₱${Number(modalItem.price || 0).toFixed(0)}`;
                }
            }

            function openItemModal(item, presetSize) {
                modalItem = item;
                lastTrigger = document.activeElement;
                setupImageFallback(modalImg);
                modalImg.src = getImagePath(item.id);
                modalImg.alt = item.name;
                modalTitle.textContent = item.name;
                modalDesc.textContent = item.description;

                modalSize.innerHTML = '';
                if (item.prices) {
                    const sizes = Object.keys(item.prices);
                    const initialSize = presetSize && sizes.includes(presetSize) ? presetSize : sizes[0];
                    modalSize.innerHTML = sizes.map(size => {
                        const label = sizeDisplayMap[size] || size;
                        return `
                        <label class="size-label modal-size-label">
                            <input type="radio" name="modal-size" value="${size}" ${size === initialSize ? 'checked' : ''}>
                            ${label}
                        </label>
                    `;}).join('');
                    modalSize.dataset.hasSizes = 'true';
                    modalSize.querySelectorAll('input[name="modal-size"]').forEach(input => {
                        input.addEventListener('change', updateModalPrice);
                    });
                } else {
                    modalSize.dataset.hasSizes = 'false';
                }

                updateModalPrice();

                itemModal.classList.add('show');
                itemModal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                requestAnimationFrame(() => modalAddBtn.focus());
            }

            function closeItemModal() {
                if (!itemModal.classList.contains('show')) return;
                itemModal.classList.remove('show');
                itemModal.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                modalItem = null;
                if (lastTrigger && typeof lastTrigger.focus === 'function') {
                    lastTrigger.focus();
                }
            }

            modalAddBtn.addEventListener('click', () => {
                if (!modalItem) return;
                const size = modalItem.prices ? getModalSelectedSize() : null;
                addItemToCart(modalItem, size);
                closeItemModal();
            });
            modalCancelBtn.addEventListener('click', closeItemModal);
            modalCloseBtn.addEventListener('click', closeItemModal);
            itemModal.addEventListener('click', event => {
                if (event.target === itemModal) closeItemModal();
            });
            document.addEventListener('keydown', event => {
                if (event.key === 'Escape' && itemModal.classList.contains('show')) {
                    closeItemModal();
                }
            });

            const categories = ['All','Milktea','Iced Coffee','Cheesecake','Fruit Tea','Soda','Frappe','Snacks','Fries'];
            const seriesNav = document.createElement('div');
            seriesNav.className = 'series-nav';
            categories.forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'series-item' + (idx === 0 ? ' active' : '');
                btn.textContent = c;
                btn.dataset.cat = c === 'All' ? 'all' : c;
                btn.setAttribute('aria-current', idx === 0 ? 'true' : 'false');
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.series-item').forEach(x => {
                        x.classList.remove('active');
                        x.setAttribute('aria-current', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-current', 'true');
                    renderList(btn.dataset.cat);
                });
                seriesNav.appendChild(btn);
            });

            const header = document.querySelector('header');
            if (header) header.insertAdjacentElement('afterend', seriesNav);

            const list = document.getElementById('menu-list');

            function renderList(filter = 'all') {
                list.innerHTML = '';
                const filtered = items.filter(it => filter === 'all' ? true : it.category === filter);
                filtered.forEach(it => {
                    const el = document.createElement('div');
                    el.className = 'menu-item';
                    // Check if this item is a best seller using the config
                    const itemIsBestSeller = isBestSeller(it.id);
                    if (itemIsBestSeller) el.classList.add('best-seller');
                    el.dataset.category = it.category;
                    const imgPath = getImagePath(it.id);
                    const badgeHTML = itemIsBestSeller ? '<span class="best-seller-badge">⭐ Best Seller</span>' : '';

                    if (it.prices) {
                        const sizeInputs = Object.keys(it.prices).map((s, i) => {
                            const checked = i === 0 ? 'checked' : '';
                            const label = sizeDisplayMap[s] || s;
                            return `<label class="size-label"><input type="radio" name="size-${it.id}" value="${s}" ${checked}> ${label}</label>`;
                        }).join('');

                        el.innerHTML = `
                            ${badgeHTML}
                            <div class="mi-left">
                                <img class="mi-img" src="${placeholderImg}" alt="${it.name}" title="${it.name}" loading="lazy" tabindex="0" role="button" />
                                <div class="mi-info">
                                    <div class="mi-title">${it.name}</div>
                                    <div class="mi-desc">${it.description}</div>
                                </div>
                            </div>
                            <div class="mi-right">
                                <div class="mi-price"></div>
                                <div class="size-select" role="group" aria-label="Size select">${sizeInputs}</div>
                                <button class="mi-add" data-id="${it.id}">Add</button>
                            </div>
                        `;
                    } else {
                        el.innerHTML = `
                            ${badgeHTML}
                            <div class="mi-left">
                                <img class="mi-img" src="${placeholderImg}" alt="${it.name}" title="${it.name}" loading="lazy" tabindex="0" role="button" />
                                <div class="mi-info">
                                    <div class="mi-title">${it.name}</div>
                                    <div class="mi-desc">${it.description}</div>
                                </div>
                            </div>
                            <div class="mi-right">
                                <div class="mi-price">P${Number(it.price).toFixed(0)}</div>
                                <button class="mi-add" data-id="${it.id}">Add</button>
                            </div>
                        `;
                    }

                    list.appendChild(el);

                    const addBtn = el.querySelector('.mi-add');
                    const imgEl = el.querySelector('.mi-img');

                        if (imgEl) {
                            setupImageFallback(imgEl);
                            imgEl.src = imgPath;
                    }

                    if (it.prices) {
                        const priceEl = el.querySelector('.mi-price');
                        const radios = el.querySelectorAll(`input[name="size-${it.id}"]`);
                        const getCardSize = () => {
                            const checked = el.querySelector(`input[name="size-${it.id}"]:checked`);
                            return checked ? checked.value : Object.keys(it.prices)[0];
                        };

                        function updateDisplayedPrice() {
                            const size = getCardSize();
                            priceEl.textContent = `P${Number(it.prices[size]).toFixed(0)}`;
                        }

                        radios.forEach(r => r.addEventListener('change', updateDisplayedPrice));
                        updateDisplayedPrice();

                        if (addBtn) {
                            addBtn.addEventListener('click', () => {
                                addItemToCart(it, getCardSize());
                            });
                        }

                        if (imgEl) {
                            imgEl.setAttribute('aria-label', `View ${it.name} details`);
                            const openModal = () => openItemModal(it, getCardSize());
                            imgEl.addEventListener('click', openModal);
                            imgEl.addEventListener('keydown', evt => {
                                if (evt.key === 'Enter' || evt.key === ' ') {
                                    evt.preventDefault();
                                    openModal();
                                }
                            });
                        }
                    } else {
                        if (addBtn) {
                            addBtn.addEventListener('click', () => addItemToCart(it, null));
                        }

                        if (imgEl) {
                            imgEl.setAttribute('aria-label', `View ${it.name} details`);
                            const openModal = () => openItemModal(it, null);
                            imgEl.addEventListener('click', openModal);
                            imgEl.addEventListener('keydown', evt => {
                                if (evt.key === 'Enter' || evt.key === ' ') {
                                    evt.preventDefault();
                                    openModal();
                                }
                            });
                        }
                    }
                });

                if (filtered.length === 0) {
                    const msg = document.createElement('div');
                    msg.textContent = 'No items found for this category.';
                    msg.style.padding = '.8rem';
                    list.appendChild(msg);
                }
            }

            renderList('all');
        });
    </script>
</head>
<body>
    <header>
        <div class="header-container">
            <!-- Menu -> go back to Home -->
            <button id="app-back" class="back-btn" aria-label="Go back" data-back="../index.html">← Back</button>

            <div class="logo">
                <img src="../assets/logo/meraki2.png" alt="Meraki Sipside logo" class="logo-mark" />
                <h1>Meraki Sipside</h1>
            </div>

            <div id="cart-preview" class="cart-preview">
                <button type="button" id="cart-preview-btn" class="cart-preview-btn">0 items • ₱0.00</button>
            </div>

            <div class="spacer"></div>
        </div>

        <nav class="navbar">
            <ul class="nav-list">
                <li><a class="nav-link" href="../index.html">Home</a></li>
                <li><a class="nav-link" href="browse.html" aria-current="page">Menu</a></li>
                <li><a class="nav-link" href="checkout.html">Checkout</a></li>
                <!-- Booking removed -->
            </ul>
        </nav>
    </header>

    <!-- Cart Modal -->
    <div id="cart-modal" class="cart-modal" role="dialog" aria-modal="true" aria-labelledby="cart-modal-title" aria-hidden="true">
        <div class="cart-modal-overlay"></div>
        <div class="cart-modal-content">
            <div class="cart-modal-header">
                <h2 id="cart-modal-title">Your Cart</h2>
                <button type="button" class="cart-modal-close" aria-label="Close cart">&times;</button>
            </div>
            <div class="cart-modal-body">
                <div id="cart-items-list" class="cart-items-list">
                    <!-- Cart items will be dynamically inserted here -->
                </div>
                <div class="cart-empty-message" style="display:none;">
                    <p>Your cart is empty</p>
                    <p class="cart-empty-subtext">Add some delicious items from our menu!</p>
                </div>
            </div>
            <div class="cart-modal-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cart-modal-total" class="cart-total-amount">₱0.00</span>
                </div>
                <div class="cart-modal-actions">
                    <button type="button" class="cart-continue-btn">Continue Shopping</button>
                    <a href="checkout.html" class="cart-checkout-btn">Checkout</a>
                </div>
            </div>
        </div>
    </div>

    <main class="page-container">
        <section class="menu-panel">
            <div class="menu-header">
                <h2>Browse Our Menu</h2>
                <p>Tap any drink or snack to see details and add it to your checkout.</p>
            </div>
            <div id="menu-list" class="menu-list"></div>
        </section>
    </main>

    <div id="item-modal" class="item-modal" aria-hidden="true">
        <div class="item-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="item-modal-title">
            <button type="button" class="modal-close" id="modal-close" aria-label="Close product details">×</button>
            <img src="../assets/menu/placeholder.jfif" alt="" class="modal-img" />
            <div class="modal-body">
                <h2 id="item-modal-title"></h2>
                <p id="item-modal-desc" class="modal-desc"></p>
                <div id="item-modal-size" class="modal-size" data-has-sizes="false"></div>
                <div id="item-modal-price" class="modal-price"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" id="modal-cancel">Cancel</button>
                <button type="button" class="modal-btn primary" id="modal-add">Add to Checkout</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Meraki Sipside. All rights reserved.</p>
    </footer>
</body>
</html>